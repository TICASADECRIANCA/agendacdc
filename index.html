<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa de Criança - Agendamento</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body {
            background-color: #f1f5f9;
            background-image: url("fundo.jpg"); /* Lendo fundo local do Git */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        @media print {
            body * { visibility: hidden; }
            #area-impressao, #area-impressao * { visibility: visible; }
            #area-impressao { position: absolute; left: 0; top: 0; width: 100%; }
            @page { margin: 1cm; }
        }
        
        .data-ativa { background-color: #2563eb !important; color: white !important; border-color: #2563eb !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="font-sans text-slate-800">

    <header class="bg-blue-900/95 backdrop-blur-sm text-white shadow-lg sticky top-0 z-50 print:hidden">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white p-1 rounded-lg">
                    <img src="logo.png" alt="Logo" class="h-12 w-12 object-contain" onerror="this.src='https://via.placeholder.com/100?text=LOGO'">
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-none">Casa de Criança</h1>
                    <span class="text-[10px] text-blue-300 uppercase tracking-widest">Agendamento de Reuniões</span>
                </div>
            </div>

            <div class="flex items-center">
                <button id="btn-login-prof" onclick="logarAdmin()" class="bg-yellow-500 hover:bg-yellow-400 text-blue-900 font-bold py-2 px-5 rounded-full text-sm transition-all flex items-center gap-2 shadow-md">
                    <i class="fas fa-lock"></i> Área do Professor
                </button>

                <button id="btn-sair-admin" onclick="sairAdmin()" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-full text-sm transition-all flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Sair do Painel
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto mt-8 p-4 mb-20 max-w-6xl print:hidden">
        
        <section id="view-pais" class="block fade-in">
            <div class="bg-white/90 backdrop-blur-md p-6 md:p-10 rounded-3xl shadow-xl border border-slate-200 text-center mb-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Agendamento</h2>
                <p class="text-slate-500 mb-8">Selecione a turma para ver os horários disponíveis</p>
                
                <div class="relative max-w-md mx-auto mb-10">
                    <select id="filtro-turma-pais" onchange="selecionarTurma()" class="w-full p-4 pl-12 text-lg border-2 border-slate-200 rounded-2xl focus:border-blue-600 outline-none bg-white cursor-pointer shadow-sm appearance-none">
                        <option value="" disabled selected>Selecione a turma...</option>
                    </select>
                    <i class="fas fa-graduation-cap absolute left-4 top-5 text-blue-600 text-xl pointer-events-none"></i>
                    <i class="fas fa-chevron-down absolute right-4 top-5 text-slate-400 pointer-events-none"></i>
                </div>

                <div id="area-datas" class="hidden text-left max-w-4xl mx-auto">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">1. Escolha a Data</h3>
                    <div id="lista-datas" class="flex flex-wrap gap-3 justify-center md:justify-start mb-10"></div>
                </div>

                <div id="area-horarios" class="hidden text-left max-w-4xl mx-auto border-t border-slate-100 pt-8 fade-in">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">2. Escolha o Horário</h3>
                    <div id="grid-horarios" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
                </div>
            </div>
        </section>

        <section id="view-admin" class="hidden space-y-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center">
                    <div id="qrcode" class="mb-4"></div>
                    <button onclick="copiarLink()" class="text-xs text-blue-600 font-bold uppercase tracking-tighter">Copiar Link do Site</button>
                </div>

                <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-4">Abrir Novos Horários</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="gen-turma" class="border p-2 rounded-lg text-sm">
                            <option value="" disabled selected>Turma</option>
                        </select>
                        <input type="date" id="gen-data" class="border p-2 rounded-lg text-sm">
                        <div class="flex gap-2">
                            <input type="time" id="gen-inicio" value="08:00" class="border p-2 rounded-lg text-sm w-1/2">
                            <input type="time" id="gen-fim" value="11:40" class="border p-2 rounded-lg text-sm w-1/2">
                        </div>
                        <button onclick="gerarAutomatico()" class="bg-blue-600 text-white font-bold rounded-lg py-2">Gerar Horários</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                    <span class="font-bold text-slate-700 text-xs uppercase">Lista de Controle</span>
                    <div class="flex gap-2">
                        <select id="select-impressao" onchange="renderAdminTable()" class="text-xs border rounded p-1">
                            <option value="">Todas as Turmas</option>
                        </select>
                        <button onclick="imprimirSelecionado()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold">Imprimir</button>
                        <button onclick="limparTudo()" class="bg-red-100 text-red-600 px-2 py-1 rounded text-[10px] font-bold">RESET</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[500px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 sticky top-0 text-[10px] text-slate-500 uppercase">
                            <tr>
                                <th class="p-4">Turma</th>
                                <th class="p-4">Data/Hora</th>
                                <th class="p-4">Responsável/Aluno</th>
                                <th class="p-4 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-admin" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="area-impressao" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDBWADP0CJMbIg5dlU_F4U-LSUbZ_KGngo",
            authDomain: "agendacdc-7c58a.firebaseapp.com",
            projectId: "agendacdc-7c58a",
            storageBucket: "agendacdc-7c58a.firebasestorage.app",
            messagingSenderId: "695482072180",
            appId: "1:695482072180:web:574479422e33dcfd3b6521"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "agendamentos");
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkCfZOtgj54l47hwmyzcvqP8muTX8dtojcOS4MQ3N1ZKqmbEhJKR7BdYPdajQVNLiVvQ/exec";

        const EMAILS_PROFESSORES = {
            "Infantil 1A": "", "Infantil 1C": "alessandrasousa@casadecrianca.com.br",
            "Infantil 2A": "girlanemelo@casadecriancaec.com.br", "Infantil 2B": "vildeniabalreira@casadecriancaec.com.br",
            "Infantil 2C": "gracamagalhaes@casadecriancaec.com.br", "Infantil 2D": "kilviabatista@casadecriancaec.com.br",
            "Infantil 2E": "brenaoliveira@casadecriancaec.com.br", "Infantil 2F": "marialuiza@casadecriancaec.com.br",
            "Infantil 2G": "anaveronicaqueiroz@casadecriancaec.com.br", "Infantil 2I": "joanacarlos@casadecriancaec.com.br",
            "Infantil 2J": "kilviabatista@casadecriancaec.com.br", "Infantil 3A": "camilareis@casadecriancaec.com.br",
            "Infantil 3B": "gabrielakatriny@casadecriancaec.com.brom", "Infantil 3C": "mikaelybezerra@casadecriancaec.com.br",
            "Infantil 3D": "camilaquirino@casadecriancaec.com.br", "Infantil 3E": "fabianesantiago@casadecriancaec.com.br",
            "Infantil 3F": "brunaferreira@casadecriancaec.com.br", "Infantil 3G": "anapaula@casadecriancaec.com.br",
            "Infantil 3H": "alinebranco@casadecriancaec.com.br", "Infantil 3I": "luizafreitas@casadecriancaec.com.br",
            "Infantil 3J": "brunaferreira@casadecriancaec.com.br", "Infantil 4A": "margotmodesto@casadecriancaec.com.br",
            "Infantil 4B": "joycevalente@casadecriancaec.com.br", "Infantil 4C": "rogenyaandrade@casadecriancaec.com.br",
            "Infantil 4D": "anabrandao@casadecriancaec.com.br", "Infantil 4E": "willianesilva@casadecriancaec.com.br",
            "Infantil 4F": "raquelsanders@casadecriancaec.com.br", "Infantil 4I": "tacianabatista@casadecriancaec.com.br",
            "Infantil 4J": "tainarasilveira@casadecriancaec.com.br", "Infantil 5A": "midiamendes@casadecriancaec.com.br",
            "Infantil 5B": "leticyaribeiro@casadecriancaec.com.br", "Infantil 5C": "daniellesouza@casadecriancaec.com.br",
            "Infantil 5D": "gerlanemendes@casadecriancaec.com.br", "Infantil 5E": "joanasilva@casadecriancaec.com.br",
            "Infantil 5F": "anaoliveira@casadecriancaec.com.br", "Infantil 5G": "nubiaconceicao@casadecriancaec.com.br",
            "Infantil 5I": "daniellesouza@casadecriancaec.com.b", "1 Ano A": "rosangelasaraiva@casadecriancaec.com.br",
            "1 Ano B": "thaissantana@casadecriancaec.com.br", "1 Ano C": "aniellesantos@casadecriancaec.com.br",
            "1 Ano D": "helizabetycastro@casadecriancaec.com.br", "1 Ano I": "michellecruz@casadecriancaec.com.br",
            "PADRAO": "Tecnologia@casadecrianca.com.br"
        };

        const TURMAS_LISTA = Object.keys(EMAILS_PROFESSORES).filter(k => k !== "PADRAO");

        let todosDados = [];
        let isAdmin = false;

        // INICIALIZAR SELECTS
        const s1 = document.getElementById('gen-turma');
        const s2 = document.getElementById('select-impressao');
        TURMAS_LISTA.sort().forEach(t => {
            const opt = `<option value="${t}">${t}</option>`;
            s1.innerHTML += opt;
            s2.innerHTML += opt;
        });

        // LOGIN E ACESSO
        window.logarAdmin = async () => {
            const { value: pass } = await Swal.fire({ title: 'Acesso Professor', input: 'password', confirmButtonColor: '#1e3a8a' });
            if (pass === '1992') {
                isAdmin = true;
                document.getElementById('view-pais').classList.add('hidden');
                document.getElementById('btn-login-prof').classList.add('hidden');
                document.getElementById('view-admin').classList.remove('hidden');
                document.getElementById('btn-sair-admin').classList.remove('hidden');
                gerarQRCode();
                renderAdminTable();
            } else if (pass) Swal.fire('Erro', 'Senha incorreta', 'error');
        };

        window.sairAdmin = () => {
            isAdmin = false;
            document.getElementById('view-admin').classList.add('hidden');
            document.getElementById('btn-sair-admin').classList.add('hidden');
            document.getElementById('view-pais').classList.remove('hidden');
            document.getElementById('btn-login-prof').classList.remove('hidden');
        };

        function gerarQRCode() {
            const url = window.location.href.split('?')[0];
            const div = document.getElementById("qrcode");
            div.innerHTML = "";
            new QRCode(div, { text: url, width: 100, height: 100 });
        }

        window.copiarLink = () => {
            navigator.clipboard.writeText(window.location.href.split('?')[0]);
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Link copiado!', showConfirmButton: false, timer: 1500 });
        };

        // FIREBASE SYNC
        const q = query(colRef, orderBy("timestamp", "asc"));
        onSnapshot(q, (snapshot) => {
            todosDados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            atualizarSelectPais();
            if(isAdmin) renderAdminTable();
        });

        function atualizarSelectPais() {
            const sel = document.getElementById('filtro-turma-pais');
            const atual = sel.value;
            const disponiveis = [...new Set(todosDados.filter(i => i.disponivel).map(i => i.turma))].sort();
            let h = '<option value="" disabled selected>Selecione a turma...</option>';
            disponiveis.forEach(t => h += `<option value="${t}">${t}</option>`);
            sel.innerHTML = h;
            if(disponiveis.includes(atual)) sel.value = atual;
        }

        window.selecionarTurma = () => {
            const t = document.getElementById('filtro-turma-pais').value;
            const hor = todosDados.filter(i => i.turma === t && i.disponivel);
            const areaD = document.getElementById('area-datas');
            document.getElementById('area-horarios').classList.add('hidden');
            if(hor.length === 0) return areaD.classList.add('hidden');
            areaD.classList.remove('hidden');
            const datas = [...new Set(hor.map(i => i.data))].sort();
            const list = document.getElementById('lista-datas');
            list.innerHTML = "";
            datas.forEach(d => {
                const b = document.createElement('button');
                b.className = "px-5 py-3 bg-white border-2 border-slate-100 rounded-xl font-bold text-slate-600 hover:border-blue-500 transition shadow-sm";
                b.innerText = d.split('-').reverse().join('/');
                b.onclick = () => {
                    document.querySelectorAll('#lista-datas button').forEach(el => el.classList.remove('data-ativa'));
                    b.classList.add('data-ativa');
                    carregarHoras(d, t);
                };
                list.appendChild(b);
            });
        };

        function carregarHoras(d, t) {
            const grid = document.getElementById('grid-horarios');
            document.getElementById('area-horarios').classList.remove('hidden');
            grid.innerHTML = "";
            todosDados.filter(i => i.data === d && i.turma === t && i.disponivel).forEach(item => {
                grid.innerHTML += `<button onclick="reservar('${item.id}', '${item.horario}', '${item.data}', '${item.turma}')" class="bg-blue-50 hover:bg-blue-600 hover:text-white text-blue-700 font-bold py-3 rounded-xl border border-blue-100 transition shadow-sm">${item.horario}</button>`;
            });
        }

        window.reservar = async (id, hora, data, turma) => {
            const dataBr = data.split('-').reverse().join('/');
            const { value: form } = await Swal.fire({
                title: 'Confirmar Horário',
                html: `
                    <div class="text-xs mb-4">${turma} - ${dataBr} às ${hora}</div>
                    <input id="sw-r" class="swal2-input" placeholder="Responsável">
                    <input id="sw-a" class="swal2-input" placeholder="Aluno">
                    <input id="sw-e" type="email" class="swal2-input" placeholder="Seu E-mail">
                `,
                preConfirm: () => {
                    const r = document.getElementById('sw-r').value;
                    const a = document.getElementById('sw-a').value;
                    const e = document.getElementById('sw-e').value;
                    if(!r || !a || !e) return Swal.showValidationMessage('Preencha tudo');
                    return { r, a, e };
                }
            });

            if(form) {
                Swal.fire({ title: 'Processando...', didOpen: () => Swal.showLoading() });
                await updateDoc(doc(db, "agendamentos", id), { 
                    disponivel: false, 
                    pai: `${form.r} (Aluno: ${form.a})` 
                });
                
                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST", mode: "no-cors",
                    body: JSON.stringify({
                        nomeResponsavel: form.r, nomeAluno: form.a, turma: turma,
                        emailProfessor: EMAILS_PROFESSORES[turma] || EMAILS_PROFESSORES["PADRAO"],
                        emailResponsavel: form.e, data: dataBr, horario: hora
                    })
                });

                Swal.fire('Sucesso!', 'Agendamento realizado.', 'success');
                document.getElementById('area-horarios').classList.add('hidden');
                document.getElementById('area-datas').classList.add('hidden');
            }
        };

        // ADMIN FUNCTIONS
        window.renderAdminTable = () => {
            const tbody = document.getElementById('tabela-admin');
            const filtro = document.getElementById('select-impressao').value;
            tbody.innerHTML = "";
            const lista = filtro ? todosDados.filter(i => i.turma === filtro) : todosDados;

            lista.forEach(i => {
                const status = i.disponivel ? 'Livre' : 'Ocupado';
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-4 font-bold">${i.turma}</td>
                        <td class="p-4">${i.data.split('-').reverse().join('/')} - ${i.horario}</td>
                        <td class="p-4">${i.pai || '-'}</td>
                        <td class="p-4 text-center flex justify-center gap-3">
                            <button onclick="liberarVaga('${i.id}')" class="text-blue-500" title="Liberar Horário"><i class="fas fa-rotate-left"></i></button>
                            <button onclick="apagarVaga('${i.id}')" class="text-red-300" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        };

        window.liberarVaga = async (id) => {
            const res = await Swal.fire({ title: 'Liberar horário?', text: "O agendamento do pai será apagado e o horário volta para a lista.", icon: 'question', showCancelButton: true });
            if(res.isConfirmed) await updateDoc(doc(db, "agendamentos", id), { disponivel: true, pai: "" });
        };

        window.apagarVaga = async (id) => {
            const res = await Swal.fire({ title: 'Remover permanentemente?', icon: 'warning', showCancelButton: true });
            if(res.isConfirmed) await deleteDoc(doc(db, "agendamentos", id));
        };

        window.gerarAutomatico = async () => {
            const t = document.getElementById('gen-turma').value;
            const d = document.getElementById('gen-data').value;
            const inicio = document.getElementById('gen-inicio').value;
            const fim = document.getElementById('gen-fim').value;
            if(!t || !d) return Swal.fire('Erro', 'Selecione turma e data', 'error');

            const batch = writeBatch(db);
            let atual = new Date(`2000-01-01T${inicio}`);
            let limite = new Date(`2000-01-01T${fim}`);

            while(atual <= limite) {
                const h = atual.toTimeString().substring(0, 5);
                const ref = doc(collection(db, "agendamentos"));
                batch.set(ref, {
                    turma: t, data: d, horario: h, disponivel: true, pai: "",
                    timestamp: new Date(`${d}T${h}`).getTime()
                });
                atual.setMinutes(atual.getMinutes() + 20);
            }
            await batch.commit();
            Swal.fire('Gerado!', 'Horários criados com sucesso.', 'success');
        };

        window.limparTudo = async () => {
            const { value: confirm } = await Swal.fire({ title: 'RESET TOTAL', text: "Digite DELETAR para apagar tudo.", input: 'text', showCancelButton: true });
            if(confirm === 'DELETAR') {
                const snap = await getDocs(colRef);
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
                Swal.fire('Limpo');
            }
        };

        window.imprimirSelecionado = () => {
            const t = document.getElementById('select-impressao').value;
            const area = document.getElementById('area-impressao');
            const dados = t ? todosDados.filter(i => i.turma === t && !i.disponivel) : todosDados.filter(i => !i.disponivel);

            let html = `<div style="padding:20px; font-family:sans-serif;">
                <h2 style="text-align:center">Agendamentos: ${t || 'Geral'}</h2>
                <table border="1" style="width:100%; border-collapse:collapse; margin-top:20px">
                    <thead><tr style="background:#f1f5f9"><th>Turma</th><th>Data/Hora</th><th>Pai / Aluno</th></tr></thead>
                    <tbody>`;
            dados.forEach(i => {
                html += `<tr><td style="padding:10px">${i.turma}</td><td style="padding:10px">${i.data.split('-').reverse().join('/')} ${i.horario}</td><td style="padding:10px">${i.pai}</td></tr>`;
            });
            html += `</tbody></table></div>`;
            area.innerHTML = html;
            window.print();
        };
    </script>
</body>
</html>

