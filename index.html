<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa de Criança - Agendamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <header class="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-shapes text-2xl text-yellow-400"></i>
                <h1 class="text-xl font-bold">Casa de Criança</h1>
            </div>
            <nav class="flex gap-2">
                <button onclick="switchView('pais')" id="btn-pais" class="px-4 py-2 bg-blue-700/50 hover:bg-blue-700 rounded-lg transition text-sm font-medium">
                    <i class="fas fa-users mr-2"></i>Pais
                </button>
                <button onclick="switchView('admin')" id="btn-admin" class="px-4 py-2 hover:bg-blue-800 rounded-lg transition text-sm font-medium opacity-80">
                    <i class="fas fa-user-shield mr-2"></i>Admin
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto mt-8 p-4 mb-20 max-w-6xl">
        
        <section id="view-pais" class="block">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 text-center mb-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Agendamento de Reuniões</h2>
                <p class="text-slate-500 mb-4">Selecione a turma abaixo para visualizar os horários disponíveis.</p>
                
                <div class="relative max-w-md mx-auto mt-4">
                    <select id="filtro-turma-pais" onchange="carregarHorariosPais()" class="w-full p-4 pl-12 text-lg border-2 border-slate-200 rounded-xl focus:border-blue-600 outline-none bg-white cursor-pointer hover:border-blue-400 transition">
                        <option value="" disabled selected>Carregando turmas...</option>
                    </select>
                    <i class="fas fa-chalkboard-user absolute left-4 top-5 text-blue-600 text-xl pointer-events-none"></i>
                </div>
            </div>

            <div id="container-horarios" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4" id="grid-horarios"></div>
                <div id="msg-vazia" class="hidden text-center text-slate-500 py-10 bg-slate-100 rounded-xl border border-slate-200">
                    <i class="fas fa-calendar-times text-4xl text-slate-300 mb-2 block"></i>
                    Nenhum horário disponível para esta turma no momento.
                </div>
            </div>
        </section>

        <section id="view-admin" class="hidden space-y-8">
            
            <div class="bg-white border-l-4 border-blue-600 p-6 rounded-2xl shadow-md">
                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-magic text-blue-600"></i> Gerador Automático de Horários
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    
                    <div class="lg:col-span-1">
                        <label class="block text-sm font-bold text-slate-600 mb-1">Turma</label>
                        <input list="lista-turmas-sugestao" id="gen-turma" class="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Infantil 1A">
                        <datalist id="lista-turmas-sugestao">
                            <option value="Infantil 1A"><option value="Infantil 1B"><option value="Infantil 2"><option value="Berçário">
                        </datalist>
                    </div>

                    <div class="lg:col-span-1">
                        <label class="block text-sm font-bold text-slate-600 mb-1">Data</label>
                        <input type="date" id="gen-data" class="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div class="lg:col-span-2">
                        <label class="block text-sm font-bold text-slate-600 mb-1">Início e Fim</label>
                        <div class="flex items-center gap-2">
                            <input type="time" id="gen-inicio" value="08:00" class="w-full border p-2.5 rounded-lg text-center font-mono">
                            <span class="text-slate-400 font-bold">às</span>
                            <input type="time" id="gen-fim" value="11:00" class="w-full border p-2.5 rounded-lg text-center font-mono">
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <label class="block text-sm font-bold text-slate-600 mb-1">Duração (min)</label>
                        <input type="number" id="gen-duracao" value="20" class="w-full border p-2.5 rounded-lg text-center font-bold text-blue-900">
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="gerarAutomatico()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition flex items-center gap-2 transform hover:-translate-y-0.5">
                        <i class="fas fa-bolt"></i> Gerar Horários Agora
                    </button>
                </div>
            </div>

            <div class="bg-indigo-50 border border-indigo-100 p-6 rounded-2xl opacity-90 hover:opacity-100 transition shadow-inner">
                <h3 class="text-sm font-bold text-indigo-900 mb-3"><i class="fas fa-file-excel mr-2"></i>Alternativa: Importar Planilha (Excel)</h3>
                <div class="flex gap-4 items-center flex-wrap">
                    <input type="file" id="input-excel" accept=".xlsx" class="block w-full md:w-auto text-sm text-slate-500 file:bg-white file:text-indigo-700 file:py-2 file:px-4 file:rounded-full file:border-0 hover:file:bg-indigo-100 cursor-pointer shadow-sm"/>
                    <button onclick="processarExcel()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold whitespace-nowrap hover:bg-indigo-700 transition shadow-md">Importar Arquivo</button>
                </div>
                <p class="text-xs text-indigo-400 mt-2 ml-1">O arquivo deve ser <b>.xlsx</b> e conter as colunas: <b>Turma</b>, <b>Data</b> e <b>Hora</b>.</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-list"></i> Últimos Horários Criados</h3>
                    <button onclick="limparTudo()" class="text-red-600 text-xs font-bold hover:bg-red-100 px-3 py-1.5 rounded transition border border-red-200">
                        <i class="fas fa-trash-alt mr-1"></i> APAGAR BANCO INTEIRO
                    </button>
                </div>
                <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 sticky top-0 text-slate-600 uppercase text-xs">
                            <tr>
                                <th class="p-3">Turma</th>
                                <th class="p-3">Data/Hora</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Responsável</th>
                                <th class="p-3 text-center">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-admin" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <script type="module">
        // Importações diretas do CDN para funcionar sem instalação
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ========================================================
        // CONFIGURAÇÃO DA CASA DE CRIANÇA (SEUS DADOS REAIS)
        // ========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDBWADP0CJMbIg5dlU_F4U-LSUbZ_KGngo",
            authDomain: "agendacdc-7c58a.firebaseapp.com",
            projectId: "agendacdc-7c58a",
            storageBucket: "agendacdc-7c58a.firebasestorage.app",
            messagingSenderId: "695482072180",
            appId: "1:695482072180:web:574479422e33dcfd3b6521"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "agendamentos");

        let todosDados = [];

        // --- 1. MONITORAMENTO EM TEMPO REAL ---
        const q = query(colRef, orderBy("timestamp", "asc"));
        
        onSnapshot(q, (snapshot) => {
            todosDados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            atualizarDropdownTurmas();
            
            // Renderiza apenas a tela ativa para não pesar
            const isPais = !document.getElementById('view-pais').classList.contains('hidden');
            if(isPais) carregarHorariosPais();
            else renderAdminTable();
        });

        // --- 2. SISTEMA TURBO (SALVAMENTO OTIMIZADO) ---
        // Salva em pacotes de 400 para garantir velocidade e estabilidade
        async function salvarEmLotes(listaDeObjetos) {
            const TAMANHO_LOTE = 400; 
            const total = listaDeObjetos.length;
            let processados = 0;

            Swal.fire({
                title: 'Processando...',
                html: `Salvando <b>${total}</b> horários no sistema.<br>Por favor, aguarde.`,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            for (let i = 0; i < total; i += TAMANHO_LOTE) {
                const loteAtual = listaDeObjetos.slice(i, i + TAMANHO_LOTE);
                const batch = writeBatch(db);
                
                loteAtual.forEach(dado => {
                    const ref = doc(collection(db, "agendamentos"));
                    batch.set(ref, dado);
                });

                await batch.commit(); // Envia o lote
                processados += loteAtual.length;
            }

            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: `${processados} horários foram criados e já estão online!`,
                confirmButtonColor: '#2563eb'
            });
        }

        // --- 3. GERADOR AUTOMÁTICO DE INTERVALOS ---
        window.gerarAutomatico = async () => {
            const turma = document.getElementById('gen-turma').value;
            const data = document.getElementById('gen-data').value;
            const inicio = document.getElementById('gen-inicio').value;
            const fim = document.getElementById('gen-fim').value;
            const duracao = parseInt(document.getElementById('gen-duracao').value);

            if (!turma || !data || !inicio || !fim || !duracao) return Swal.fire('Atenção', 'Preencha todos os campos corretamente.', 'warning');
            
            const [hIni, mIni] = inicio.split(':').map(Number);
            const [hFim, mFim] = fim.split(':').map(Number);
            
            let minutoAtual = hIni * 60 + mIni;
            const minutoFim = hFim * 60 + mFim;
            const novosHorarios = [];

            // Loop Matemático para criar os slots
            while (minutoAtual + duracao <= minutoFim + (duracao - 1)) {
                if (minutoAtual >= minutoFim) break;
                
                const h = Math.floor(minutoAtual / 60);
                const m = minutoAtual % 60;
                const horaFormatada = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                novosHorarios.push({
                    turma: turma,
                    data: data,
                    horario: horaFormatada,
                    disponivel: true,
                    pai: "",
                    timestamp: new Date(`${data}T${horaFormatada}`)
                });
                minutoAtual += duracao;
            }

            if (novosHorarios.length === 0) return Swal.fire('Ops', 'O intervalo de tempo é muito curto para essa duração.', 'info');

            // Confirmação antes de salvar
            const confirm = await Swal.fire({
                title: 'Confirmar?',
                text: `Vou criar ${novosHorarios.length} horários para a turma ${turma}.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sim, criar!',
                confirmButtonColor: '#2563eb'
            });

            if(confirm.isConfirmed) {
                await salvarEmLotes(novosHorarios);
            }
        };

        // --- 4. IMPORTAÇÃO EXCEL (BLINDADA) ---
        window.processarExcel = async () => {
            const fileInput = document.getElementById('input-excel');
            const file = fileInput.files[0];
            if (!file) return Swal.fire('Erro', 'Selecione um arquivo .xlsx', 'error');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    // Lê como texto puro para não bugar datas do Excel
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, dateNF: 'dd/mm/yyyy' });

                    if(json.length === 0) return Swal.fire('Vazio', 'A planilha parece estar vazia.', 'warning');

                    const listaParaSalvar = [];
                    json.forEach(row => {
                        const keys = Object.keys(row);
                        // Procura colunas inteligente (ignora maiusculas/minusculas)
                        const turma = row[keys.find(k => k.toLowerCase().includes('turma'))];
                        const dataBr = row[keys.find(k => k.toLowerCase().includes('data'))];
                        const hora = row[keys.find(k => k.toLowerCase().includes('hora'))];

                        if(turma && dataBr && hora) {
                            // Converte data brasileira para padrão ISO (Banco de dados)
                            let dataIso = dataBr;
                            if(dataBr.includes('/')) {
                                const parts = dataBr.split('/');
                                if(parts.length === 3) dataIso = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                            listaParaSalvar.push({
                                turma: String(turma).trim(),
                                data: dataIso,
                                horario: String(hora).trim(),
                                disponivel: true,
                                pai: "",
                                timestamp: new Date(`${dataIso}T${hora}`)
                            });
                        }
                    });

                    if(listaParaSalvar.length === 0) return Swal.fire('Erro', 'Não encontrei colunas Turma, Data e Hora.', 'error');

                    await salvarEmLotes(listaParaSalvar);
                    fileInput.value = ""; // Limpa o input
                } catch (err) { 
                    console.error(err);
                    Swal.fire('Erro Técnico', 'Falha ao ler o arquivo Excel. Verifique o formato.', 'error'); 
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // --- 5. FUNÇÕES DE INTERFACE ---
        function atualizarDropdownTurmas() {
            const turmasUnicas = [...new Set(todosDados.map(item => item.turma))].sort();
            const select = document.getElementById('filtro-turma-pais');
            const valorAtual = select.value;
            let html = '<option value="" disabled selected>Clique para escolher sua turma...</option>';
            turmasUnicas.forEach(turma => html += `<option value="${turma}">${turma}</option>`);
            select.innerHTML = html;
            if(turmasUnicas.includes(valorAtual)) select.value = valorAtual;
        }

        window.carregarHorariosPais = () => {
            const turma = document.getElementById('filtro-turma-pais').value;
            const container = document.getElementById('container-horarios');
            const grid = document.getElementById('grid-horarios');
            const msg = document.getElementById('msg-vazia');
            if(!turma) { container.classList.add('hidden'); return; }
            
            container.classList.remove('hidden');
            grid.innerHTML = "";
            const filtrados = todosDados.filter(i => i.turma === turma && i.disponivel);

            if(filtrados.length === 0) {
                msg.classList.remove('hidden');
            } else {
                msg.classList.add('hidden');
                filtrados.forEach(item => {
                    const dataBr = item.data.split('-').reverse().join('/');
                    grid.innerHTML += `
                        <div class="bg-white border border-slate-200 p-4 rounded-xl hover:shadow-lg transition transform hover:-translate-y-1">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-blue-700 bg-blue-100 px-2 py-1 rounded">${dataBr}</span>
                                <i class="fas fa-clock text-slate-300"></i>
                            </div>
                            <div class="text-3xl font-bold text-slate-800 mb-4 text-center">${item.horario}</div>
                            <button onclick="reservar('${item.id}', '${item.horario}')" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 shadow-sm active:scale-95 transition">
                                Reservar
                            </button>
                        </div>`;
                });
            }
        };

        window.renderAdminTable = () => {
            const tbody = document.getElementById('tabela-admin');
            tbody.innerHTML = "";
            
            // FILTRO DE PERFORMANCE: Mostra só os 100 últimos se tiver muitos
            let dadosView = todosDados;
            if (todosDados.length > 100) {
                dadosView = todosDados.slice(-100).reverse(); 
            } else {
                dadosView = [...todosDados].reverse();
            }

            dadosView.forEach(item => {
                const dataBr = item.data.split('-').reverse().join('/');
                tbody.innerHTML += `
                    <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                        <td class="p-3 font-medium text-slate-700">${item.turma}</td>
                        <td class="p-3 text-slate-600 font-mono text-xs">${dataBr} - ${item.horario}</td>
                        <td class="p-3">
                            <span class="text-xs font-bold px-2 py-1 rounded ${item.disponivel ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${item.disponivel ? 'LIVRE' : 'OCUPADO'}
                            </span>
                        </td>
                        <td class="p-3 text-slate-500 text-sm truncate max-w-[150px]">${item.pai || '-'}</td>
                        <td class="p-3 text-center">
                            <button onclick="deletar('${item.id}')" class="text-slate-400 hover:text-red-600 transition p-2 rounded-full hover:bg-red-50" title="Apagar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });

            if(todosDados.length > 100) {
                tbody.innerHTML += `<tr><td colspan="5" class="text-center text-xs text-slate-400 p-2 bg-slate-50 italic">Exibindo os 100 registros mais recentes de um total de ${todosDados.length}.</td></tr>`;
            }
        };

        // --- 6. AÇÕES GERAIS ---
        window.reservar = async (id, hora) => {
            const { value: nome } = await Swal.fire({
                title: 'Confirmar Reserva',
                html: `Horário: <b>${hora}</b><br>Digite o nome do Responsável/Aluno:`,
                input: 'text',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                confirmButtonText: 'Confirmar Agendamento',
                inputValidator: (value) => { if(!value) return 'O nome é obrigatório!' }
            });

            if (nome) {
                try {
                    await updateDoc(doc(db, "agendamentos", id), { disponivel: false, pai: nome });
                    Swal.fire('Sucesso!', `Horário agendado para <b>${nome}</b>.`, 'success');
                } catch(e) {
                    Swal.fire('Erro', 'Este horário já pode ter sido pego por outra pessoa.', 'error');
                }
            }
        };

        window.deletar = async (id) => {
            if(confirm('Tem certeza que deseja apagar este horário específico?')) {
                await deleteDoc(doc(db, "agendamentos", id));
            }
        };

        window.limparTudo = async () => {
            const confirmacao = await Swal.fire({
                title: 'ATENÇÃO MÁXIMA!',
                text: "Isso vai APAGAR TODOS os horários de TODAS as turmas do banco de dados. Essa ação não tem volta. Digite 'DELETAR' para confirmar:",
                input: 'text',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                confirmButtonText: 'Apagar Tudo Agora'
            });

            if(confirmacao.value === 'DELETAR') {
                Swal.fire({ title: 'Limpando banco...', html: 'Isso pode demorar alguns segundos.', didOpen: () => Swal.showLoading() });
                
                // Apaga em lotes para não falhar
                const snapshot = await getDocs(colRef);
                const total = snapshot.docs.length;
                const batchSize = 400;
                
                for(let i=0; i<total; i+=batchSize){
                    const batch = writeBatch(db);
                    snapshot.docs.slice(i, i+batchSize).forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }

                Swal.fire('Concluído', 'O banco de dados está limpo.', 'success');
            }
        };

        window.switchView = (view) => {
            if(view === 'admin') {
                // Senha configurada: 1992
                const senha = prompt('Digite a senha de administrador da Casa de Criança:');
                if(senha !== '1992') return Swal.fire('Acesso Negado', 'Senha incorreta.', 'error');
            }
            document.getElementById('view-pais').classList.toggle('hidden', view !== 'pais');
            document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
            
            if(view === 'admin') renderAdminTable();
        }
    </script>
</body>
</html>
